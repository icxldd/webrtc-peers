<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <script>
      const getType = function(val) {
  if (val && val.buffer && val.buffer instanceof ArrayBuffer) {
    return 'ArrayBuffer'
  }
  const toString = Object.prototype.toString
  return toString.call(val).slice(8, -1)
}
      a = {
        a: null,
        b: "sss",
        c: [1, { a: new Uint8Array([1, 34])}, new Blob(['asf']), 22],
        d: new Uint8Array([1, 34, 1, 34, 123]),
        e: new Blob(["faaa"]),
        f: {
          ac: 1,
          d: new Uint8Array([2, 34, 23])
        }
      };

 function dataToBlob(obj) {
  let record = [], // [['a.b.c', 2341334]]
    buffers = [], //[buffer]
    nwObj = {}
  obj = { _: obj }
 
  function start(obj, nwObj, path = []) {
    for (let key in obj) {
      let val = obj[key],
        keypath = [...path, key].join('.'),
        type = getType(val)

      if (getType(val) === 'ArrayBuffer') {
        record.push([keypath, `1, ${val.byteLength}`])
        buffers.push(val)
        continue
      }
      if (val instanceof Blob) {
        record.push([keypath, `2, ${val.size}`])
        buffers.push(val)
        continue
      }
      
      if (type === 'Array') {
        nwObj[key] = []
        start(val, [...path, key])
      } else if (type === 'Object') {
        nwObj[key] = Object.create(null)
      } else {
        nwObj[key] = val
      }
      if (typeof val === 'object') {
        start(val,nwObj[key], [...path, key])
      }
    }
  }
  start(obj,nwObj)
  console.log(nwObj,record,buffers)
  let b = new Blob([JSON.stringify([nwObj, record])])
  // '1100,[obj,record]buffers' 其中1100[obj,record]所占的长度
  return new Blob([`${b.size},`, b, ...buffers])
}

    // buff = b.arrayBuffer().then(res => {
    //   console.log('bf',res, 'back', back(res))
    // })
    // let d = new TextDecoder()
    
    function back(buff) {
 
      buff = new Uint8Array(buff)
      let len = buff.indexOf(44)
      let aa = d.decode(buff.subarray(0, len))
      buff = buff.subarray(len+1)
     let  aaa = d.decode(buff.subarray(0,aa))
     console.log(aaa)
      let [obj, record] = JSON.parse(aaa)
      console.log(record)
      buff = buff.subarray(aa)
      for (let [keypath, val] of record) {
        let [type, size] = val.split(',')
        let buf = buff.subarray(0, +size)  
        if(type == 2) {
          buf = new Blob([buf])
        }
        keypath = keypath.split('.')
        let obj2 = obj
        for(let i=0;i< keypath.length;i++) {
          let key = keypath[i]
          if(i === keypath.length-1) {
            obj2[key] = buf
          } else {
            obj2 = obj2[key]
          }
        }
        buff = buff.subarray(+size)

      }
      return obj
    }

    </script>
  </body>
</html>
